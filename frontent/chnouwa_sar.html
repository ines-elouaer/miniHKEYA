<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>miniHKEYA ‚Äì Jeu CHNOUWA SAR ?</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 15px;
    }
    select, button {
      padding: 6px 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      cursor: pointer;
    }
    button.primary {
      background: #2196f3;
      color: white;
      border: none;
    }
    button.secondary {
      background: #673ab7;
      color: white;
      border: none;
      margin-top: 10px;
    }
    .block {
      margin-top: 15px;
    }
    .story {
      background: #fafafa;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #ddd;
      white-space: pre-wrap;
    }
    .blank-row {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .blank-label {
      font-weight: bold;
    }
    .choice-btn {
      padding: 5px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #eee;
      cursor: pointer;
    }
    .choice-btn.selected {
      background: #4caf50;
      color: white;
      border-color: #4caf50;
    }
    .result {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
      background: #e8f5e9;
      border: 1px solid #c8e6c9;
    }
    .error {
      color: red;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéÆ Jeu ‚ÄúCHNOUWA SAR ?‚Äù</h1>

    <div class="row">
      <div>
        <label>Th√®me :</label>
        <select id="theme-select">
          <option value="souk">Souk</option>
          <option value="famille">Famille</option>
          <option value="ecole">√âcole</option>
        </select>
      </div>
      <div>
        <label>Niveau :</label>
        <select id="level-select">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
        </select>
      </div>
      <button id="game-start-btn" class="primary">Commencer une histoire</button>
    </div>

    <div id="game-error" class="error"></div>

    <div id="raw-story-block" class="block" style="display:none;">
      <h3>Histoire g√©n√©r√©e (brute) :</h3>
      <div id="raw-story" class="story"></div>
    </div>

    <div id="masked-story-block" class="block" style="display:none;">
      <h3>Histoire √† trous :</h3>
      <div id="masked-story" class="story"></div>

      <div id="blanks-container" class="block"></div>

      <button id="game-check-btn" class="secondary">V√©rifier mes r√©ponses</button>
    </div>

    <div id="game-result-block" class="block" style="display:none;">
      <h3>R√©sultat :</h3>
      <div id="game-result" class="result"></div>
    </div>
  </div>

  <script>
    const API_BASE = "http://127.0.0.1:8000";

    const themeSelect = document.getElementById("theme-select");
    const levelSelect = document.getElementById("level-select");
    const gameStartBtn = document.getElementById("game-start-btn");
    const gameCheckBtn = document.getElementById("game-check-btn");

    const gameError = document.getElementById("game-error");

    const rawStoryBlock = document.getElementById("raw-story-block");
    const rawStoryDiv = document.getElementById("raw-story");

    const maskedStoryBlock = document.getElementById("masked-story-block");
    const maskedStoryDiv = document.getElementById("masked-story");
    const blanksContainer = document.getElementById("blanks-container");

    const gameResultBlock = document.getElementById("game-result-block");
    const gameResultDiv = document.getElementById("game-result");

    let currentStoryId = null;
    let currentBlanks = [];
    let selectedAnswers = {};

    gameStartBtn.addEventListener("click", async () => {
      gameError.textContent = "";
      gameResultBlock.style.display = "none";
      maskedStoryBlock.style.display = "none";
      rawStoryBlock.style.display = "none";
      blanksContainer.innerHTML = "";
      selectedAnswers = {};

      const theme = themeSelect.value;
      const level = parseInt(levelSelect.value, 10);

      try {
        const genRes = await fetch(API_BASE + "/game/story/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ theme, level })
        });

        if (!genRes.ok) throw new Error("Erreur /game/story/generate");
        const genData = await genRes.json();

        currentStoryId = genData.story_id;
        const rawStory = genData.raw_story;

        rawStoryDiv.textContent = rawStory;
        rawStoryBlock.style.display = "block";

        const maskRes = await fetch(API_BASE + "/game/story/mask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            story_id: currentStoryId,
            raw_story: rawStory,
            level
          })
        });

        if (!maskRes.ok) throw new Error("Erreur /game/story/mask");
        const maskData = await maskRes.json();

        maskedStoryDiv.textContent = maskData.masked_story;
        maskedStoryBlock.style.display = "block";

        currentBlanks = maskData.blanks || [];
        renderBlanks();
      } catch (e) {
        console.error(e);
        gameError.textContent =
          "Erreur API : " + e.message +
          " (v√©rifie que le backend tourne sur http://127.0.0.1:8000)";
      }
    });

    function renderBlanks() {
      blanksContainer.innerHTML = "";
      currentBlanks.forEach(blank => {
        const row = document.createElement("div");
        row.className = "blank-row";

        const label = document.createElement("span");
        label.className = "blank-label";
        label.textContent = "Trou " + blank.blank_id + " :";
        row.appendChild(label);

        blank.choices.forEach(choice => {
          const btn = document.createElement("button");
          btn.className = "choice-btn";
          btn.textContent = choice;

          btn.addEventListener("click", () => {
            selectedAnswers[blank.blank_id] = choice;
            updateSelectedButtons();
          });

          row.appendChild(btn);
        });

        blanksContainer.appendChild(row);
      });
    }

    function updateSelectedButtons() {
      const rows = blanksContainer.getElementsByClassName("blank-row");
      Array.from(rows).forEach((row, index) => {
        const blank = currentBlanks[index];
        const buttons = row.getElementsByTagName("button");
        Array.from(buttons).forEach(btn => {
          if (selectedAnswers[blank.blank_id] === btn.textContent) {
            btn.classList.add("selected");
          } else {
            btn.classList.remove("selected");
          }
        });
      });
    }

    gameCheckBtn.addEventListener("click", async () => {
      if (!currentStoryId || currentBlanks.length === 0) return;

      const answersArray = currentBlanks.map(b => ({
        blank_id: b.blank_id,
        answer: selectedAnswers[b.blank_id] || ""
      }));

      try {
        const res = await fetch(API_BASE + "/game/story/check", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            story_id: currentStoryId,
            answers: answersArray
          })
        });

        if (!res.ok) throw new Error("Erreur /game/story/check");
        const data = await res.json();

        gameResultDiv.innerHTML =
          "Score : <b>" + data.score + "</b> / " + data.max_score +
          "<br>" + data.feedback;
        gameResultBlock.style.display = "block";
      } catch (e) {
        console.error(e);
        gameError.textContent = "Erreur API : " + e.message;
      }
    });
  </script>
</body>
</html>
