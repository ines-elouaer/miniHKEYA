<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>miniHKEYA ‚Äì Quiz vocabulaire</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
    }
    button {
      padding: 6px 10px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background: #2196f3;
      color: white;
      margin-top: 10px;
    }
    button.secondary {
      background: #673ab7;
    }
    .error {
      color: red;
      margin-top: 10px;
    }
    .block {
      margin-top: 15px;
    }
    .question-box {
      background: #fafafa;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    .quiz-choices {
      margin-top: 10px;
    }
    .quiz-choice {
      display: block;
      margin-bottom: 5px;
      cursor: pointer;
    }
    .quiz-footer {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .badge {
      display: inline-block;
      background: #ffeb3b;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      margin-left: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìù Quiz vocabulaire tunisien</h1>

    <div id="quiz-error" class="error"></div>

    <button id="quiz-start-btn">Charger le quiz</button>

    <div id="quiz-block" class="block" style="display:none;">
      <div class="question-box">
        <div id="quiz-question-text"></div>
      </div>

      <div id="quiz-choices" class="quiz-choices"></div>

      <div class="quiz-footer">
        <span id="quiz-progress"></span>
        <button id="quiz-validate-btn" class="secondary">Valider</button>
        <button id="quiz-next-btn">Question suivante</button>
      </div>

      <div id="quiz-feedback" class="block"></div>
      <div id="quiz-final-result" class="block" style="display:none;"></div>
    </div>
  </div>

  <script>
    const API_BASE = "http://127.0.0.1:8000";

    const quizStartBtn = document.getElementById("quiz-start-btn");
    const quizBlock = document.getElementById("quiz-block");
    const quizQuestionText = document.getElementById("quiz-question-text");
    const quizChoicesDiv = document.getElementById("quiz-choices");
    const quizProgress = document.getElementById("quiz-progress");
    const quizValidateBtn = document.getElementById("quiz-validate-btn");
    const quizNextBtn = document.getElementById("quiz-next-btn");
    const quizFeedback = document.getElementById("quiz-feedback");
    const quizFinalResult = document.getElementById("quiz-final-result");
    const quizError = document.getElementById("quiz-error");

    let quizQuestions = [];
    let quizIndex = 0;
    let quizScore = 0;
    let quizSelectedIndex = null;
    let quizLocked = false;

    quizStartBtn.addEventListener("click", async () => {
      quizError.textContent = "";
      quizFeedback.textContent = "";
      quizFinalResult.style.display = "none";
      quizScore = 0;
      quizIndex = 0;
      quizSelectedIndex = null;
      quizLocked = false;

      try {
        const res = await fetch(API_BASE + "/api/quiz/questions");
        if (!res.ok) throw new Error("Erreur API /api/quiz/questions");
        const data = await res.json();
        quizQuestions = data.questions || [];
        if (quizQuestions.length === 0) {
          quizError.textContent = "Aucune question trouv√©e.";
          return;
        }
        quizBlock.style.display = "block";
        afficherQuestionQuiz();
      } catch (e) {
        console.error(e);
        quizError.textContent = "Erreur : " + e.message;
      }
    });

    function afficherQuestionQuiz() {
      quizFeedback.textContent = "";
      quizSelectedIndex = null;
      quizLocked = false;

      const q = quizQuestions[quizIndex];
      quizQuestionText.textContent = q.question;

      quizChoicesDiv.innerHTML = "";
      q.choices.forEach((choice, idx) => {
        const label = document.createElement("label");
        label.className = "quiz-choice";

        const radio = document.createElement("input");
        radio.type = "radio";
        radio.name = "quiz-choice";
        radio.value = idx;

        radio.addEventListener("change", () => {
          quizSelectedIndex = idx;
        });

        label.appendChild(radio);
        label.appendChild(document.createTextNode(" " + choice));
        quizChoicesDiv.appendChild(label);
      });

      quizProgress.textContent =
        "Question " + (quizIndex + 1) + " / " + quizQuestions.length;
    }

    quizValidateBtn.addEventListener("click", () => {
      if (quizLocked) return;
      const q = quizQuestions[quizIndex];
      if (quizSelectedIndex === null) {
        quizFeedback.textContent = "Choisis une r√©ponse s'il te pla√Æt.";
        return;
      }

      if (quizSelectedIndex === q.correct_index) {
        quizScore++;
        quizFeedback.innerHTML =
          "<span style='color:green;'>‚úÖ Bonne r√©ponse !</span> " +
          (q.explanation || "");
      } else {
        const correctText = q.choices[q.correct_index];
        quizFeedback.innerHTML =
          "<span style='color:red;'>‚ùå Mauvaise r√©ponse.</span> " +
          "La bonne r√©ponse √©tait : <b>" + correctText + "</b>. " +
          (q.explanation || "");
      }

      quizLocked = true;
      if (quizIndex === quizQuestions.length - 1) {
        afficherScoreFinal();
      }
    });

    quizNextBtn.addEventListener("click", () => {
      if (quizIndex < quizQuestions.length - 1) {
        quizIndex++;
        afficherQuestionQuiz();
      } else {
        afficherScoreFinal();
      }
    });

    function afficherScoreFinal() {
      quizFinalResult.style.display = "block";
      quizFinalResult.innerHTML =
        "<b>Score final :</b> " +
        quizScore +
        " / " +
        quizQuestions.length;

      if (quizScore === quizQuestions.length) {
        quizFinalResult.innerHTML +=
          " <span class='badge'>Ma√Ætre du vocabulaire üáπüá≥</span>";
      }
    }
  </script>
</body>
</html>
